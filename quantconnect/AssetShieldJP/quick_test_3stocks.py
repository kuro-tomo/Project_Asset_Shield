# region imports
from AlgorithmImports import *
import numpy as np
from datetime import datetime, timedelta
# endregion


class JapanStockData(PythonData):
    def GetSource(self, config, date, isLiveMode):
        return SubscriptionDataSource(
            f"japan_stocks/{config.Symbol.Value}.csv",
            SubscriptionTransportMedium.ObjectStore,
            FileFormat.Csv
        )

    def Reader(self, config, line, date, isLiveMode):
        if not line.strip() or not line[0].isdigit():
            return None
        try:
            c = line.split(',')
            d = JapanStockData()
            d.Symbol = config.Symbol
            d.Time = datetime.strptime(c[0], "%Y-%m-%d")
            d.EndTime = d.Time + timedelta(days=1)
            d.Value = float(c[4])
            d["Volume"] = int(float(c[5]))
            return d
        except:
            return None


class QuickTest3Stocks(QCAlgorithm):
    """
    Quick Test: 3 Japanese Stocks via ObjectStore
    =============================================
    Verify data pipeline works before full deployment.
    """

    STOCKS = ["72030", "67580", "83060"]  # Toyota, Sony, MUFG

    def Initialize(self):
        self.SetStartDate(2020, 1, 1)
        self.SetEndDate(2026, 1, 31)
        self.SetCash(10_000_000)

        self.symbols = {}
        self.data = {}
        self.data_count = 0
        self.last_rebalance = None

        for code in self.STOCKS:
            sym = self.AddData(JapanStockData, code, Resolution.Daily)
            self.symbols[code] = sym.Symbol
            self.data[code] = None
            self.Debug(f"Added: {code}")

        if not self.symbols:
            raise Exception("No data - upload CSVs first")

        self.Debug(f"Initialized with {len(self.symbols)} symbols")

    def OnData(self, slice):
        # Receive data
        for code, sym in self.symbols.items():
            if slice.ContainsKey(sym):
                bar = slice[sym]
                if bar and bar.Value > 0:
                    self.data[code] = {"price": bar.Value, "vol": bar["Volume"]}
                    self.data_count += 1

        # Monthly rebalance check (in OnData instead of Schedule)
        if self.last_rebalance is None or (self.Time - self.last_rebalance).days >= 30:
            self.Rebalance()
            self.last_rebalance = self.Time

    def Rebalance(self):
        if self.data_count < 10:
            return

        equity = self.Portfolio.TotalPortfolioValue
        active = sum(1 for d in self.data.values() if d)

        self.Debug(f"[{self.Time.date()}] Equity: ¥{equity:,.0f} | Active: {active} | Data: {self.data_count}")

        # Simple equal weight
        for code, sym in self.symbols.items():
            if self.data[code] and self.data[code]["price"] > 0:
                self.SetHoldings(sym, 0.30)

    def OnEndOfAlgorithm(self):
        eq = self.Portfolio.TotalPortfolioValue
        ret = (eq / 10_000_000) - 1

        self.Debug("=" * 50)
        self.Debug("QUICK TEST RESULTS")
        self.Debug("=" * 50)
        self.Debug(f"Data Points: {self.data_count}")
        self.Debug(f"Total Return: {ret:.2%}")
        self.Debug(f"Final Equity: ¥{eq:,.0f}")

        if self.data_count > 0:
            self.Debug("✓ SUCCESS: Data pipeline working!")
            self.Debug("Next: Run full 20-stock backtest")
        else:
            self.Debug("✗ FAILED: No data received")
            self.Debug("Check: ObjectStore has japan_stocks/*.csv")


# ============================================================
# DATA UPLOADER - Run this FIRST (3 stocks only)
# ============================================================

class DataUploader3Stocks(QCAlgorithm):
    """Upload 3 stocks for quick test"""

    def Initialize(self):
        self.SetStartDate(2024, 1, 1)
        self.SetEndDate(2024, 1, 2)
        self.SetCash(1000)

        # Toyota (72030) - 2020-2024 sample data
        toyota_data = """2020-01-06,1508.0,1517.0,1503.0,7579.0,17568400
2020-01-07,1505.0,1519.5,1498.5,7557.0,20377800
2020-01-08,1485.0,1504.0,1477.5,7502.0,26685900
2020-01-09,1501.5,1514.5,1496.5,7537.0,21432800
2020-01-10,1514.0,1518.5,1496.0,7478.0,20096700
2020-01-14,1506.0,1532.0,1502.0,7600.0,22614400
2020-01-15,1526.5,1530.5,1517.5,7600.0,17245000
2020-01-16,1536.0,1541.5,1528.0,7647.0,19298900
2020-01-17,1546.0,1546.5,1530.0,7665.0,18889300
2020-01-20,1540.0,1557.0,1538.0,7745.0,17619100
2020-02-03,1458.5,1469.5,1449.0,7340.0,19428600
2020-03-02,1350.0,1380.0,1340.0,6800.0,25000000
2020-04-01,1280.0,1300.0,1260.0,6400.0,22000000
2020-05-01,1320.0,1350.0,1300.0,6600.0,20000000
2020-06-01,1400.0,1420.0,1380.0,7000.0,18000000
2020-07-01,1380.0,1400.0,1360.0,6900.0,17000000
2020-08-03,1420.0,1450.0,1400.0,7100.0,19000000
2020-09-01,1500.0,1520.0,1480.0,7500.0,21000000
2020-10-01,1480.0,1500.0,1460.0,7400.0,18000000
2020-11-02,1520.0,1550.0,1500.0,7600.0,20000000
2020-12-01,1600.0,1620.0,1580.0,8000.0,22000000
2021-01-04,1650.0,1680.0,1630.0,8200.0,24000000
2021-02-01,1700.0,1720.0,1680.0,8500.0,21000000
2021-03-01,1750.0,1780.0,1730.0,8700.0,23000000
2021-04-01,1800.0,1830.0,1780.0,9000.0,25000000
2021-05-06,1780.0,1800.0,1760.0,8900.0,20000000
2021-06-01,1820.0,1850.0,1800.0,9100.0,22000000
2021-07-01,1900.0,1930.0,1880.0,9500.0,26000000
2021-08-02,1950.0,1980.0,1930.0,9700.0,24000000
2021-09-01,2000.0,2030.0,1980.0,10000.0,28000000
2021-10-01,1980.0,2000.0,1960.0,9900.0,23000000
2021-11-01,2050.0,2080.0,2030.0,10200.0,25000000
2021-12-01,2100.0,2130.0,2080.0,10500.0,27000000
2022-01-04,2150.0,2180.0,2130.0,10700.0,26000000
2022-02-01,2200.0,2230.0,2180.0,11000.0,24000000
2022-03-01,2100.0,2130.0,2080.0,10500.0,28000000
2022-04-01,2150.0,2180.0,2130.0,10700.0,25000000
2022-05-02,2200.0,2230.0,2180.0,11000.0,23000000
2022-06-01,2250.0,2280.0,2230.0,11200.0,26000000
2022-07-01,2180.0,2200.0,2160.0,10900.0,22000000
2022-08-01,2220.0,2250.0,2200.0,11100.0,24000000
2022-09-01,2150.0,2180.0,2130.0,10700.0,21000000
2022-10-03,2100.0,2130.0,2080.0,10500.0,23000000
2022-11-01,2180.0,2210.0,2160.0,10900.0,25000000
2022-12-01,2250.0,2280.0,2230.0,11200.0,27000000
2023-01-04,2300.0,2330.0,2280.0,11500.0,28000000
2023-02-01,2350.0,2380.0,2330.0,11700.0,26000000
2023-03-01,2400.0,2430.0,2380.0,12000.0,29000000
2023-04-03,2450.0,2480.0,2430.0,12200.0,27000000
2023-05-01,2500.0,2530.0,2480.0,12500.0,30000000
2023-06-01,2600.0,2630.0,2580.0,13000.0,32000000
2023-07-03,2700.0,2730.0,2680.0,13500.0,31000000
2023-08-01,2800.0,2830.0,2780.0,14000.0,33000000
2023-09-01,2750.0,2780.0,2730.0,13700.0,29000000
2023-10-02,2700.0,2730.0,2680.0,13500.0,28000000
2023-11-01,2850.0,2880.0,2830.0,14200.0,31000000
2023-12-01,2950.0,2980.0,2930.0,14700.0,34000000
2024-01-04,3050.0,3080.0,3030.0,15200.0,35000000
2024-02-01,3150.0,3180.0,3130.0,15700.0,33000000
2024-03-01,3250.0,3280.0,3230.0,16200.0,36000000
2024-04-01,3350.0,3380.0,3330.0,16700.0,34000000
2024-05-01,3400.0,3430.0,3380.0,17000.0,32000000
2024-06-03,3450.0,3480.0,3430.0,17200.0,31000000
2024-07-01,3500.0,3530.0,3480.0,17500.0,33000000
2024-08-01,3400.0,3430.0,3380.0,17000.0,35000000
2024-09-02,3450.0,3480.0,3430.0,17200.0,30000000
2024-10-01,3500.0,3530.0,3480.0,17500.0,32000000
2024-11-01,3550.0,3580.0,3530.0,17700.0,31000000
2024-12-02,3600.0,3630.0,3580.0,18000.0,34000000
2025-01-06,3650.0,3680.0,3630.0,18200.0,33000000
2025-02-03,3700.0,3730.0,3680.0,18500.0,35000000"""

        # Sony (67580)
        sony_data = """2020-01-06,7415.0,7530.0,7415.0,7530.0,6894200
2020-01-07,7430.0,7555.0,7411.0,7465.0,9181100
2020-01-08,7390.0,7500.0,7330.0,7444.0,11665800
2020-02-03,7331.0,7405.0,7255.0,7400.0,11033300
2020-03-02,6800.0,6900.0,6700.0,6850.0,12000000
2020-04-01,6500.0,6600.0,6400.0,6550.0,10000000
2020-05-01,6700.0,6800.0,6600.0,6750.0,11000000
2020-06-01,7000.0,7100.0,6900.0,7050.0,9000000
2020-07-01,7200.0,7300.0,7100.0,7250.0,10000000
2020-08-03,7500.0,7600.0,7400.0,7550.0,11000000
2020-09-01,7800.0,7900.0,7700.0,7850.0,12000000
2020-10-01,8000.0,8100.0,7900.0,8050.0,10000000
2020-11-02,8500.0,8600.0,8400.0,8550.0,13000000
2020-12-01,9000.0,9100.0,8900.0,9050.0,14000000
2021-01-04,9500.0,9600.0,9400.0,9550.0,15000000
2021-02-01,10000.0,10100.0,9900.0,10050.0,14000000
2021-03-01,10500.0,10600.0,10400.0,10550.0,16000000
2021-04-01,11000.0,11100.0,10900.0,11050.0,15000000
2021-05-06,10800.0,10900.0,10700.0,10850.0,13000000
2021-06-01,11200.0,11300.0,11100.0,11250.0,14000000
2021-07-01,11500.0,11600.0,11400.0,11550.0,15000000
2021-08-02,11800.0,11900.0,11700.0,11850.0,14000000
2021-09-01,12000.0,12100.0,11900.0,12050.0,16000000
2021-10-01,11800.0,11900.0,11700.0,11850.0,13000000
2021-11-01,12200.0,12300.0,12100.0,12250.0,15000000
2021-12-01,12500.0,12600.0,12400.0,12550.0,14000000
2022-01-04,12800.0,12900.0,12700.0,12850.0,16000000
2022-02-01,12500.0,12600.0,12400.0,12550.0,14000000
2022-03-01,12000.0,12100.0,11900.0,12050.0,15000000
2022-04-01,11500.0,11600.0,11400.0,11550.0,13000000
2022-05-02,11000.0,11100.0,10900.0,11050.0,14000000
2022-06-01,10500.0,10600.0,10400.0,10550.0,12000000
2022-07-01,10800.0,10900.0,10700.0,10850.0,13000000
2022-08-01,11200.0,11300.0,11100.0,11250.0,14000000
2022-09-01,10800.0,10900.0,10700.0,10850.0,12000000
2022-10-03,10500.0,10600.0,10400.0,10550.0,13000000
2022-11-01,11000.0,11100.0,10900.0,11050.0,14000000
2022-12-01,11500.0,11600.0,11400.0,11550.0,15000000
2023-01-04,12000.0,12100.0,11900.0,12050.0,16000000
2023-02-01,12500.0,12600.0,12400.0,12550.0,15000000
2023-03-01,13000.0,13100.0,12900.0,13050.0,17000000
2023-04-03,13500.0,13600.0,13400.0,13550.0,16000000
2023-05-01,14000.0,14100.0,13900.0,14050.0,18000000
2023-06-01,14500.0,14600.0,14400.0,14550.0,17000000
2023-07-03,15000.0,15100.0,14900.0,15050.0,19000000
2023-08-01,14500.0,14600.0,14400.0,14550.0,16000000
2023-09-01,14000.0,14100.0,13900.0,14050.0,15000000
2023-10-02,13500.0,13600.0,13400.0,13550.0,14000000
2023-11-01,14000.0,14100.0,13900.0,14050.0,16000000
2023-12-01,14500.0,14600.0,14400.0,14550.0,17000000
2024-01-04,15000.0,15100.0,14900.0,15050.0,18000000
2024-02-01,15500.0,15600.0,15400.0,15550.0,17000000
2024-03-01,16000.0,16100.0,15900.0,16050.0,19000000
2024-04-01,16500.0,16600.0,16400.0,16550.0,18000000
2024-05-01,16000.0,16100.0,15900.0,16050.0,16000000
2024-06-03,15500.0,15600.0,15400.0,15550.0,15000000
2024-07-01,16000.0,16100.0,15900.0,16050.0,17000000
2024-08-01,15500.0,15600.0,15400.0,15550.0,16000000
2024-09-02,16000.0,16100.0,15900.0,16050.0,18000000
2024-10-01,16500.0,16600.0,16400.0,16550.0,17000000
2024-11-01,17000.0,17100.0,16900.0,17050.0,19000000
2024-12-02,17500.0,17600.0,17400.0,17550.0,18000000
2025-01-06,18000.0,18100.0,17900.0,18050.0,20000000
2025-02-03,18500.0,18600.0,18400.0,18550.0,19000000"""

        # MUFG (83060)
        mufg_data = """2020-01-06,567.8,574.2,567.3,574.2,38942800
2020-01-07,568.5,574.3,565.3,567.9,47696400
2020-01-08,559.7,568.4,555.6,563.7,58610900
2020-02-03,551.3,558.9,547.9,558.5,42825400
2020-03-02,480.0,490.0,470.0,485.0,60000000
2020-04-01,420.0,430.0,410.0,425.0,55000000
2020-05-01,400.0,410.0,390.0,405.0,50000000
2020-06-01,450.0,460.0,440.0,455.0,48000000
2020-07-01,420.0,430.0,410.0,425.0,45000000
2020-08-03,430.0,440.0,420.0,435.0,47000000
2020-09-01,440.0,450.0,430.0,445.0,46000000
2020-10-01,420.0,430.0,410.0,425.0,44000000
2020-11-02,480.0,490.0,470.0,485.0,52000000
2020-12-01,500.0,510.0,490.0,505.0,50000000
2021-01-04,520.0,530.0,510.0,525.0,55000000
2021-02-01,560.0,570.0,550.0,565.0,53000000
2021-03-01,600.0,610.0,590.0,605.0,58000000
2021-04-01,620.0,630.0,610.0,625.0,56000000
2021-05-06,600.0,610.0,590.0,605.0,52000000
2021-06-01,620.0,630.0,610.0,625.0,54000000
2021-07-01,600.0,610.0,590.0,605.0,50000000
2021-08-02,580.0,590.0,570.0,585.0,48000000
2021-09-01,600.0,610.0,590.0,605.0,52000000
2021-10-01,620.0,630.0,610.0,625.0,54000000
2021-11-01,640.0,650.0,630.0,645.0,56000000
2021-12-01,660.0,670.0,650.0,665.0,55000000
2022-01-04,680.0,690.0,670.0,685.0,58000000
2022-02-01,700.0,710.0,690.0,705.0,56000000
2022-03-01,750.0,760.0,740.0,755.0,62000000
2022-04-01,780.0,790.0,770.0,785.0,60000000
2022-05-02,760.0,770.0,750.0,765.0,55000000
2022-06-01,740.0,750.0,730.0,745.0,52000000
2022-07-01,720.0,730.0,710.0,725.0,50000000
2022-08-01,740.0,750.0,730.0,745.0,53000000
2022-09-01,760.0,770.0,750.0,765.0,55000000
2022-10-03,800.0,810.0,790.0,805.0,60000000
2022-11-01,850.0,860.0,840.0,855.0,62000000
2022-12-01,900.0,910.0,890.0,905.0,65000000
2023-01-04,950.0,960.0,940.0,955.0,68000000
2023-02-01,1000.0,1010.0,990.0,1005.0,70000000
2023-03-01,1050.0,1060.0,1040.0,1055.0,72000000
2023-04-03,1100.0,1110.0,1090.0,1105.0,70000000
2023-05-01,1150.0,1160.0,1140.0,1155.0,73000000
2023-06-01,1200.0,1210.0,1190.0,1205.0,75000000
2023-07-03,1250.0,1260.0,1240.0,1255.0,74000000
2023-08-01,1300.0,1310.0,1290.0,1305.0,76000000
2023-09-01,1250.0,1260.0,1240.0,1255.0,70000000
2023-10-02,1200.0,1210.0,1190.0,1205.0,68000000
2023-11-01,1300.0,1310.0,1290.0,1305.0,72000000
2023-12-01,1400.0,1410.0,1390.0,1405.0,78000000
2024-01-04,1500.0,1510.0,1490.0,1505.0,82000000
2024-02-01,1550.0,1560.0,1540.0,1555.0,80000000
2024-03-01,1600.0,1610.0,1590.0,1605.0,85000000
2024-04-01,1650.0,1660.0,1640.0,1655.0,83000000
2024-05-01,1700.0,1710.0,1690.0,1705.0,86000000
2024-06-03,1750.0,1760.0,1740.0,1755.0,84000000
2024-07-01,1800.0,1810.0,1790.0,1805.0,88000000
2024-08-01,1700.0,1710.0,1690.0,1705.0,82000000
2024-09-02,1750.0,1760.0,1740.0,1755.0,85000000
2024-10-01,1800.0,1810.0,1790.0,1805.0,87000000
2024-11-01,1850.0,1860.0,1840.0,1855.0,86000000
2024-12-02,1900.0,1910.0,1890.0,1905.0,90000000
2025-01-06,1950.0,1960.0,1940.0,1955.0,92000000
2025-02-03,2000.0,2010.0,1990.0,2005.0,95000000"""

        # Upload
        self.ObjectStore.Save("japan_stocks/72030.csv", toyota_data)
        self.ObjectStore.Save("japan_stocks/67580.csv", sony_data)
        self.ObjectStore.Save("japan_stocks/83060.csv", mufg_data)

        self.Debug("=" * 50)
        self.Debug("Uploaded 3 stocks (2020-2025 data)")
        self.Debug("  72030 (Toyota)")
        self.Debug("  67580 (Sony)")
        self.Debug("  83060 (MUFG)")
        self.Debug("=" * 50)
        self.Debug("Next: Change class to QuickTest3Stocks and run")

    def OnData(self, data):
        pass
